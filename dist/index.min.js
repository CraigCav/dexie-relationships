!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("dexie")):"function"==typeof define&&define.amd?define(["dexie"],t):e.dexieRelationships=t(e.Dexie)}(this,function(e){"use strict";function t(e){return null!=e&&("string"==typeof e||"number"==typeof e||e instanceof Date||Array.isArray(e)&&e.every(t))}e="default"in e?e.default:e;var n=function(e){this.schema=e};n.prototype.getForeignKeys=function(){var e=this,t={};return Object.keys(this.schema).forEach(function(n){var r=e.schema[n].split(",");t[n]=r.filter(function(e){return e.indexOf("->")!==-1}).map(function(e){var t=e.split("->").map(function(e){return e.trim()}),n=t[0],r=t[1];return{index:n,targetTable:r.split(".")[0],targetIndex:r.split(".")[1]}})}),t},n.prototype.getCleanedSchema=function(){var e=this,t={};return Object.keys(this.schema).forEach(function(n){var r=e.schema[n].split(",");t[n]=r.map(function(e){return e.split("->")[0].trim()}).join(",")}),t};var r=function(r){var o=e.Promise;r.Table.prototype.with=function(e){return this.toCollection().with(e)},r.Collection.prototype.with=function(e){var n=this,i=this._ctx.table.name,a=r._allTables,f={};Object.keys(e).forEach(function(t){var r=e[t],o=n._ctx.table.schema.idxByName[r];if(o&&o.hasOwnProperty("foreignKey")){var c=o;f[c.foreignKey.targetTable]={column:t,index:c.foreignKey.targetIndex,targetIndex:c.foreignKey.index,oneToOne:!0}}else{var u=r;if(!a.hasOwnProperty(u))throw new Error("Relationship table "+u+" doesn't exist.");if(!a[u].schema.hasOwnProperty("foreignKeys"))throw new Error("Relationship table "+u+" doesn't have foreign keys set.");var s=a[u].schema.foreignKeys.filter(function(e){return e.targetTable===i});s.length>0&&(f[u]={column:t,index:s[0].index,targetIndex:s[0].targetIndex})}});var c=Object.keys(f);return this.toArray().then(function(e){var n=c.map(function(n){var r=f[n],o=e.map(function(e){return e[r.targetIndex]}).filter(t);return a[n].where(r.index).anyOf(o)}),r=n.map(function(e){return e.toArray()});return o.all(r).then(function(t){c.forEach(function(n,r){var o=f[n],a=t[r],c=o.targetIndex,u=o.index,s=o.column,l={};e.forEach(function(e){l[e[c]]=e,o.oneToOne||Object.defineProperty(e,s,{value:[],enumerable:!1,configurable:!0,writable:!0})}),a.forEach(function(e){var t=e[u],r=l[t];if(!r)throw new Error("Could not lookup foreign key where "+n+"."+u+" == "+i+"."+s+". The content of the failing key was: "+JSON.stringify(t)+".");o.oneToOne?Object.defineProperty(r,s,{value:e,enumerable:!1,configurable:!0,writable:!0}):r[s].push(e)})})}).then(function(){return e})})},r.Version.prototype._parseStoresSpec=e.override(r.Version.prototype._parseStoresSpec,function(e){return function(t,r){var o=new n(t),i=o.getForeignKeys(),a=e.call(this,o.getCleanedSchema(),r);return Object.keys(r).forEach(function(e){i.hasOwnProperty(e)&&(r[e].foreignKeys=i[e],i[e].forEach(function(t){r[e].idxByName[t.index].foreignKey=t}))}),a}})};return r});
